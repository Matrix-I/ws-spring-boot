<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>STOMP WebSocket JWT Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
</head>
<body>
<h1>STOMP WebSocket with JWT</h1>
<button onclick="connect()">Connect</button>
<button onclick="sendMessage()">Send</button>
<input id="msg" placeholder="Type message..."/>
<div id="log"></div>

<script>
    let stompClient;

    async function connect() {
        const token = await fetch("http://localhost:8080/auth/token")
            .then(r => r.text());
        log("Token: " + token);

        const decoded = jwt_decode(token);
        const currentUser = decoded.sub;   // <- set current user from JWT "sub"

        const socket = new SockJS("http://localhost:8080/ws?token=" + encodeURIComponent(token));
        stompClient = Stomp.over(socket);


        stompClient.connect(
            {Authorization: "Bearer " + token}, // send JWT in headers
            (frame) => {
                log("Connected: " + frame);
                // subscribe to broadcast topic
                stompClient.subscribe("/topic/messages", (message) => {
                    // // ignore messages from current user
                    // if (message.headers.simpSessionId !== currentUser) {
                    //     log("Received: " + message.body);
                    // }

                    log("Received: " + message.body);
                });
            },
            (error) => log("Connection error: " + error)
        );
    }

    function sendMessage() {
        if (stompClient && stompClient.connected) {
            const msg = document.getElementById("msg").value || "Hello from client";
            stompClient.send("/app/chat", {}, msg);
        } else {
            log("Not connected.");
        }
    }

    function log(msg) {
        document.getElementById("log").innerHTML += "<p>" + msg + "</p>";
    }
</script>
</body>
</html>
